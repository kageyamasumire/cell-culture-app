<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>モル濃度（Selleck式）計算機：単位切替対応</title>
<style>
  body{background:#0f172a;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo}
  .wrap{max-width:900px;margin:0 auto;padding:18px}
  h1{font-size:1.25rem;margin:0 0 4px}
  p.sub{color:#cbd5e1;margin:0 0 14px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:14px;margin:12px 0}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .line{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0}
  label{color:#cbd5e1}
  input[type="number"]{width:120px;padding:8px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  select{padding:8px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  .eq{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;color:#93c5fd}
  .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .primary{background:#2563eb;color:#fff}
  .secondary{background:#374151;color:#fff}
  .out{white-space:pre-wrap;background:#0b1220;border:1px dashed #334155;border-radius:10px;padding:12px;margin-top:10px}
  .muted{color:#94a3b8;font-size:.9rem}
  .solve{display:flex;align-items:center;gap:6px;margin-left:6px;color:#cbd5e1}
</style>
</head>
<body>
<div class="wrap">
  <h1>モル濃度（Selleck式）計算機</h1>
  <p class="sub">方程式：<span class="eq">質量 (mg) = 濃度 (mM) × 体積 (mL) × 分子量 (g/mol)</span></p>

  <div class="card">
    <div class="line">
      <strong>質量</strong>：
      <input id="mass" type="number" step="any" placeholder="数値">
      <select id="uMass">
        <option>mg</option><option>g</option><option>µg</option>
      </select>
      <label class="solve"><input type="radio" name="solve" value="mass"> これを計算</label>
    </div>

    <div class="line">
      <strong>濃度</strong>：
      <input id="conc" type="number" step="any" placeholder="数値">
      <select id="uConc">
        <option>mM</option><option>M</option><option>µM</option><option>nM</option>
      </select>
      <label class="solve"><input type="radio" name="solve" value="conc"> これを計算</label>
    </div>

    <div class="line">
      <strong>体積</strong>：
      <input id="vol" type="number" step="any" placeholder="数値">
      <select id="uVol">
        <option>mL</option><option>L</option><option>µL</option>
      </select>
      <label class="solve"><input type="radio" name="solve" value="vol"> これを計算</label>
    </div>

    <div class="line">
      <strong>分子量</strong>：
      <input id="mw" type="number" step="any" placeholder="g/mol">
      <span class="muted">(g/mol)</span>
    </div>

    <div class="row" style="margin-top:6px">
      <button class="btn primary" onclick="calc()">計算</button>
      <button class="btn secondary" onclick="resetAll()">リセット</button>
    </div>

    <div id="out" class="out" style="display:none"></div>
    <p class="muted" style="margin-top:8px">
      ※ 単位は自動で内部換算します。計算したい項目に「これを計算」をつけ、他の値と分子量を入力してください。<br>
      例）<b>質量</b>を計算：濃度=5 mM、体積=10 mL、分子量=180.16 を入れて「計算」。
    </p>
  </div>

  <div class="card">
    <h3>やさしい説明</h3>
    <p class="muted">
      ① まず単位をそろえます（mg / mM / mL）。<br>
      ② 式 <span class="eq">mg = mM × mL × g/mol</span> を使います。<br>
      ③ 求めたいものに合わせて式を並べ替えます：<br>
      ・濃度 = mg ÷ (mL × g/mol)　・体積 = mg ÷ (mM × g/mol)　・質量 = mM × mL × g/mol
    </p>
  </div>
</div>

<script>
// 単位変換
function massToMg(val, u){ // -> mg
  if (u==='mg') return val;
  if (u==='g')  return val*1000;
  if (u==='µg' || u==='ug') return val/1000;
  return val;
}
function mgToBest(mg){
  if (mg>=1000) return {v:(mg/1000), u:'g'};
  if (mg>=1)    return {v:mg,       u:'mg'};
  return {v:(mg*1000), u:'µg'};
}
function concTo_mM(val, u){ // -> mM
  if (u==='mM') return val;
  if (u==='M')  return val*1000;
  if (u==='µM' || u==='uM') return val/1000;
  if (u==='nM') return val/1e6;
  return val;
}
function mM_toBest(mM){
  if (mM>=1000) return {v:mM/1000, u:'M'};
  if (mM>=1)    return {v:mM,      u:'mM'};
  if (mM>=1e-3) return {v:mM*1000, u:'µM'};
  return {v:mM*1e6, u:'nM'};
}
function volTo_mL(val, u){ // -> mL
  if (u==='mL') return val;
  if (u==='L')  return val*1000;
  if (u==='µL' || u==='uL') return val/1000;
  return val;
}
function mL_toBest(mL){
  if (mL>=1000) return {v:mL/1000, u:'L'};
  if (mL>=1)    return {v:mL,      u:'mL'};
  return {v:mL*1000, u:'µL'};
}
function fmt(x, d=6){
  if (!isFinite(x)) return String(x);
  const s = Number(x).toPrecision(d);
  return s.replace(/(\.\d*?[1-9])0+$/,'$1').replace(/\.0+$/,'');
}

function calc(){
  const target = document.querySelector('input[name="solve"]:checked')?.value;
  const massVal = parseFloat(document.getElementById('mass').value);
  const uMass   = document.getElementById('uMass').value;
  const concVal = parseFloat(document.getElementById('conc').value);
  const uConc   = document.getElementById('uConc').value;
  const volVal  = parseFloat(document.getElementById('vol').value);
  const uVol    = document.getElementById('uVol').value;
  const mw      = parseFloat(document.getElementById('mw').value);

  const outEl = document.getElementById('out');
  outEl.style.display='block';

  if(!target){ outEl.textContent='計算したい項目に「これを計算」をチェックしてください。'; return; }
  if(!(mw>0)){ outEl.textContent='分子量（g/mol）を入力してください。'; return; }

  // 標準単位に変換：mg / mM / mL
  const mg  = (massVal>0) ? massToMg(massVal, uMass) : NaN;
  const mM  = (concVal>0) ? concTo_mM(concVal, uConc) : NaN;
  const mL  = (volVal>0)  ? volTo_mL(volVal,  uVol)   : NaN;

  // 式: mg = mM * mL * MW(g/mol)
  let msg = '';

  if(target==='mass'){
    if(!(mM>0 && mL>0)){ outEl.textContent='濃度と体積を入力してください。'; return; }
    const mgCalc = mM * mL * mw;
    const best = mgToBest(mgCalc);
    msg = `質量 = 濃度 × 体積 × 分子量
= ${fmt(mM)} mM × ${fmt(mL)} mL × ${fmt(mw)} g/mol
= ${fmt(mgCalc)} mg ≈ ${fmt(best.v)} ${best.u}`;
  }
  else if(target==='conc'){
    if(!(isFinite(mg) && mL>0)){ outEl.textContent='質量と体積を入力してください。'; return; }
    const mMcalc = mg / (mL * mw);
    const best = mM_toBest(mMcalc);
    msg = `濃度 = 質量 ÷ (体積 × 分子量)
= ${fmt(mg)} mg ÷ (${fmt(mL)} mL × ${fmt(mw)} g/mol)
= ${fmt(mMcalc)} mM ≈ ${fmt(best.v)} ${best.u}`;
  }
  else if(target==='vol'){
    if(!(isFinite(mg) && mM>0)){ outEl.textContent='質量と濃度を入力してください。'; return; }
    const mLcalc = mg / (mM * mw);
    const best = mL_toBest(mLcalc);
    msg = `体積 = 質量 ÷ (濃度 × 分子量)
= ${fmt(mg)} mg ÷ (${fmt(mM)} mM × ${fmt(mw)} g/mol)
= ${fmt(mLcalc)} mL ≈ ${fmt(best.v)} ${best.u}`;
  }

  outEl.textContent = `【結果】\n` + msg;
}

function resetAll(){
  ['mass','conc','vol','mw'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('uMass').value='mg';
  document.getElementById('uConc').value='mM';
  document.getElementById('uVol').value='mL';
  const c = document.querySelector('input[name="solve"]:checked'); if(c) c.checked=false;
  document.getElementById('out').style.display='none';
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>投与溶液組成計算機（Dose & Dilution Suite）</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--line:#1f2937;--muted:#94a3b8;--hi:#93c5fd}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo}
  .wrap{max-width:1000px;margin:0 auto;padding:18px}
  h1{font-size:1.35rem;margin:0 0 8px}
  h2{margin:10px 0}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin:12px 0}
  .line{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:6px 0}
  .line strong{min-width:7em}
  input[type="number"],input[type="text"],select{
    padding:8px 10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb
  }
  input[type="number"]{width:140px}
  .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .primary{background:#2563eb;color:#fff}
  .secondary{background:#374151;color:#fff}
  .out{white-space:pre-wrap;background:#0b1220;border:1px dashed #334155;border-radius:10px;padding:12px;margin-top:10px}
  .muted{color:var(--muted);font-size:.9rem}
  .eq{font-family:ui-monospace,Consolas,Menlo,monospace;color:var(--hi)}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #1f2937;padding:8px;text-align:right}
  th{background:#0f1a32}
  td:first-child,th:first-child{text-align:left}
  .grid2{display:grid;gap:10px}
  @media(min-width:760px){.grid2{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>投与溶液組成計算機</h1>

  <!-- 投与溶液：ステップ1+2 -->
  <div class="card">
    <h2>ステップ1：実験データ</h2>
    <p class="muted">実験操作によるロスを考慮し、<b>動物数+1匹</b>で計算することを推奨します（チェック可）。</p>
    <div class="line"><strong>投与量:</strong>
      <input id="dose_mgkg" type="number" step="any" placeholder="例: 10">
      <span>mg/kg</span>
    </div>
    <div class="line"><strong>動物平均体重:</strong>
      <input id="avg_g" type="number" step="any" placeholder="例: 22">
      <span>g</span>
    </div>
    <div class="line"><strong>投与体積(動物毎):</strong>
      <input id="vol_uL" type="number" step="any" placeholder="例: 200">
      <span>μL</span>
    </div>
    <div class="line"><strong>動物数:</strong>
      <input id="n_animals" type="number" step="1" placeholder="例: 5">
      <label style="display:flex;align-items:center;gap:6px;margin-left:8px">
        <input id="add_one" type="checkbox" checked> +1匹で計算
      </label>
    </div>

    <h2 style="margin-top:16px">ステップ2：投与溶媒の組成（%）</h2>
    <p class="muted">例）<b>DMSO 10%</b> + <b>PEG300 40%</b> + <b>Tween80 5%</b> + <b>ddH2O 45%</b> = 100%</p>
    <div class="grid2">
      <div class="line"><strong>DMSO:</strong><input id="p_dmsO" type="number" step="any" value="10"><span>%</span></div>
      <div class="line"><strong>PEG300:</strong><input id="p_peg" type="number" step="any" value="40"><span>%</span></div>
      <div class="line"><strong>Tween 80:</strong><input id="p_tw" type="number" step="any" value="5"><span>%</span></div>
      <div class="line"><strong>ddH₂O:</strong><input id="p_h2o" type="number" step="any" value="45"><span>%</span></div>
    </div>

    <div class="line" style="margin-top:10px">
      <button class="btn primary" onclick="calcDose()">計算</button>
      <button class="btn secondary" onclick="resetDose()">リセット</button>
    </div>
    <div id="outDose" class="out" style="display:none"></div>
  </div>

  <!-- 希釈計算器 -->
  <div class="card">
    <h2>希釈計算器（C1V1 = C2V2）</h2>
    <p class="muted">方程式：<span class="eq">Concentration(start) × Volume(start) = Concentration(final) × Volume(final)</span></p>
    <div class="grid2">
      <div>
        <div class="line"><strong>C1:</strong><input id="c1" type="number" step="any"><select id="uC1"><option>M</option><option selected>mM</option><option>µM</option><option>nM</option><option>%</option></select></div>
        <div class="line"><strong>V1:</strong><input id="v1" type="number" step="any"><select id="uV1"><option>L</option><option selected>mL</option><option>µL</option></select></div>
      </div>
      <div>
        <div class="line"><strong>C2:</strong><input id="c2" type="number" step="any"><select id="uC2"><option>M</option><option selected>mM</option><option>µM</option><option>nM</option><option>%</option></select></div>
        <div class="line"><strong>V2:</strong><input id="v2" type="number" step="any"><select id="uV2"><option>L</option><option selected>mL</option><option>µL</option></select></div>
      </div>
    </div>
    <div class="line" style="margin-top:8px">
      <button class="btn primary" onclick="calcDil()">計算</button>
      <button class="btn secondary" onclick="resetDil()">リセット</button>
    </div>
    <div id="outDil" class="out" style="display:none"></div>
  </div>

  <!-- 連続希釈計算器 -->
  <div class="card">
    <h2>連続希釈計算器</h2>
    <div class="line"><strong>初めの濃度 C0:</strong><input id="c0" type="number" step="any"><select id="uC0"><option>M</option><option selected>mM</option><option>µM</option><option>nM</option></select></div>
    <div class="line"><strong>稀釈倍数 X:</strong><input id="xf" type="number" step="any" placeholder="例: 10"></div>
    <div class="line">
      <button class="btn primary" onclick="calcSerial()">計算</button>
    </div>
    <div id="outSerial" class="out" style="display:none"></div>
    <div style="overflow-x:auto">
      <table id="tblSerial" style="display:none">
        <thead><tr><th>段数</th><th>濃度</th><th>単位</th><th>log10(濃度[M])</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 分子量計算器 -->
  <div class="card">
    <h2>分子量計算器（化学式 → モル質量）</h2>
    <div class="line"><strong>化学式:</strong><input id="formula" type="text" placeholder="例: C10H16N2O2"></div>
    <div class="line">
      <button class="btn primary" onclick="calcMW()">計算</button>
      <span class="muted">※ 化学式は大文字小文字を区別します（C と c は別物）。括弧( )と係数も可。</span>
    </div>
    <div id="outMW" class="out" style="display:none"></div>
    <div style="overflow-x:auto">
      <table id="tblMW" style="display:none">
        <thead><tr><th>元素</th><th>個数</th><th>原子量</th><th>寄与質量</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3">合計</th><th id="mwSum"></th></tr></tfoot>
      </table>
    </div>
    <p class="muted" style="margin-top:6px">* 貯蔵液を準備する時は、製品バッチ固有の分子量（ラベル・SDS/COA）を参照してください。</p>
  </div>
</div>

<script>
// ------------- 共通ユーティリティ -------------
const CtoM = u => ({M:1, mM:1e-3, "µM":1e-6, "uM":1e-6, nM:1e-9}[u] ?? 1);
const MtoBest = M => (M>=1?{v:M,u:"M"}:M>=1e-3?{v:M*1e3,u:"mM"}:M>=1e-6?{v:M*1e6,u:"µM"}:{v:M*1e9,u:"nM"});
const VtoL = u => ({L:1, mL:1e-3, "µL":1e-6, "uL":1e-6}[u] ?? 1);
const LtoBest = L => (L>=1?{v:L,u:"L"}:L>=1e-3?{v:L*1e3,u:"mL"}:{v:L*1e6,u:"µL"});
function fmt(x,d=6){ if(!isFinite(x))return String(x); const s=Number(x).toPrecision(d); return s.replace(/(\.\d*?[1-9])0+$/,'$1').replace(/\.0+$/,''); }
function show(id, text){const el=document.getElementById(id); el.style.display='block'; el.textContent=text;}
function hide(id){document.getElementById(id).style.display='none';}

// ------------- 投与溶液 -------------
function calcDose(){
  const dose = parseFloat(document.getElementById('dose_mgkg').value); // mg/kg
  const avg_g = parseFloat(document.getElementById('avg_g').value);    // g
  const vol_uL = parseFloat(document.getElementById('vol_uL').value);  // µL/animal
  let n = parseInt(document.getElementById('n_animals').value||'0',10);
  const addOne = document.getElementById('add_one').checked;
  if(!(dose>0 && avg_g>0 && vol_uL>0 && n>0)){ show('outDose','入力を確認してください。'); return; }
  const nEff = addOne? n+1 : n;
  const wt_kg = avg_g/1000;
  const dosePerAnimal_mg = dose * wt_kg;             // mg / animal
  const volPerAnimal_mL = vol_uL/1000;               // mL / animal
  const targetConc_mg_mL = dosePerAnimal_mg / volPerAnimal_mL; // mg/mL
  const totalVol_mL = volPerAnimal_mL * nEff;        // mL
  const totalAPI_mg = targetConc_mg_mL * totalVol_mL;// mg

  // 溶媒配分
  const pD = parseFloat(document.getElementById('p_dmsO').value||'0');
  const pP = parseFloat(document.getElementById('p_peg').value||'0');
  const pT = parseFloat(document.getElementById('p_tw').value||'0');
  const pW = parseFloat(document.getElementById('p_h2o').value||'0');
  const sumP = pD+pP+pT+pW;
  if(Math.abs(sumP-100)>1e-6){ show('outDose',`溶媒の%合計が ${fmt(sumP)}% です。100% にしてください。`); return; }

  const vD = totalVol_mL * pD/100, vP = totalVol_mL * pP/100, vT = totalVol_mL * pT/100, vW = totalVol_mL * pW/100;

  const text =
`【結果】
・目標濃度: ${fmt(targetConc_mg_mL)} mg/mL
・総体積: ${fmt(totalVol_mL)} mL （${n}匹${addOne?'＋1匹分':''}）
・必要API量: ${fmt(totalAPI_mg)} mg

【溶媒配分（%→mL）】
DMSO: ${fmt(vD)} mL
PEG300: ${fmt(vP)} mL
Tween80: ${fmt(vT)} mL
ddH₂O: ${fmt(vW)} mL

【作業メモ】
1) APIを先に DMSO(+一部PEG) で溶解 → 2) Tween80 → 3) ddH₂O で仕上げ体積へ。
* ロット差で溶解性が異なります。実際のSOP/安全情報に従ってください。`;
  show('outDose', text);
}
function resetDose(){
  ['dose_mgkg','avg_g','vol_uL','n_animals'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('p_dmsO').value=10; document.getElementById('p_peg').value=40;
  document.getElementById('p_tw').value=5; document.getElementById('p_h2o').value=45;
  document.getElementById('add_one').checked=true;
  hide('outDose');
}

// ------------- 希釈 C1V1=C2V2 -------------
function calcDil(){
  const c1 = parseFloat(document.getElementById('c1').value);
  const uC1 = document.getElementById('uC1').value;
  const v1 = parseFloat(document.getElementById('v1').value);
  const uV1 = document.getElementById('uV1').value;
  const c2 = parseFloat(document.getElementById('c2').value);
  const uC2 = document.getElementById('uC2').value;
  const v2 = parseFloat(document.getElementById('v2').value);
  const uV2 = document.getElementById('uV2').value;

  if(!((c1>0||c2>0) && (v1>0||v2>0))){ show('outDil','C1/C2とV1/V2のうち、片側は埋めてください。'); return; }

  // %同士 or M系同士しか不可
  const isPct = u => u==='%';
  if (isPct(uC1) !== isPct(uC2)){ show('outDil','濃度の単位は % 同士 か M系同士 に揃えてください。'); return; }

  let C1 = isPct(uC1)? c1 : c1*CtoM(uC1); // → M or %
  let C2 = isPct(uC2)? c2 : c2*CtoM(uC2);
  let V1 = v1*VtoL(uV1) || NaN;           // → L
  let V2 = v2*VtoL(uV2) || NaN;

  // 求める
  if(!isFinite(V1) && isFinite(C1) && isFinite(C2) && isFinite(V2)){ V1 = (C2*V2)/C1; }
  else if(!isFinite(V2) && isFinite(C1) && isFinite(C2) && isFinite(V1)){ V2 = (C1*V1)/C2; }
  else if(!isFinite(C1) && isFinite(C2) && isFinite(V1) && isFinite(V2)){ C1 = (C2*V2)/V1; }
  else if(!isFinite(C2) && isFinite(C1) && isFinite(V1) && isFinite(V2)){ C2 = (C1*V1)/V2; }
  else { show('outDil','未入力の箇所（1つ）を作ってください。'); return; }

  // 表示単位はV2側に合わせる
  const v1Best = LtoBest(V1), v2Best = LtoBest(V2);
  const c1Str = isPct(uC1)? `${fmt(C1)} %` : `${fmt(MtoBest(C1).v)} ${MtoBest(C1).u}`;
  const c2Str = isPct(uC2)? `${fmt(C2)} %` : `${fmt(MtoBest(C2).v)} ${MtoBest(C2).u}`;

  const out =
`【結果】
C1×V1 = C2×V2
${c1Str} × ${fmt(v1Best.v)} ${v1Best.u}  =  ${c2Str} × ${fmt(v2Best.v)} ${v2Best.u}

・V1 = ${fmt(v1Best.v)} ${v1Best.u}
・V2 = ${fmt(v2Best.v)} ${v2Best.u}
・溶媒 = V2 − V1 = ${fmt(v2Best.v - V1/VtoL(v2Best.u))} ${v2Best.u}`;
  show('outDil', out);
}
function resetDil(){
  ['c1','v1','c2','v2'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('uC1').value='mM'; document.getElementById('uC2').value='mM';
  document.getElementById('uV1').value='mL'; document.getElementById('uV2').value='mL';
  hide('outDil');
}

// ------------- 連続希釈 -------------
function calcSerial(){
  const c0 = parseFloat(document.getElementById('c0').value);
  const u0 = document.getElementById('uC0').value;
  const X = parseFloat(document.getElementById('xf').value);
  if(!(c0>0 && X>1)){ show('outSerial','C0 (>0) と 稀釈倍数X (>1) を入力してください。'); return; }

  const C0_M = c0*CtoM(u0);
  let txt = `初期: ${fmt(c0)} ${u0} ＝ ${fmt(C0_M)} M\n`;
  show('outSerial', txt);

  const tbody = document.querySelector('#tblSerial tbody');
  tbody.innerHTML = '';
  for(let i=1;i<=8;i++){
    const Ci_M = C0_M / Math.pow(X,i);
    const best = MtoBest(Ci_M);
    const log10 = Math.log10(Ci_M);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>C${i} = C${i-1>=1?i-1:0}/${X}</td><td>${fmt(best.v)}</td><td>${best.u}</td><td>${isFinite(log10)?fmt(log10,5):'−∞'}</td>`;
    tbody.appendChild(tr);
  }
  document.getElementById('tblSerial').style.display='table';
}

// ------------- 分子量（化学式）-------------
// 主要元素の標準原子量（IUPAC推奨近似）
const AWT = {
  H:1.00794, He:4.002602, Li:6.941, Be:9.012182, B:10.811, C:12.0107, N:14.0067, O:15.9994,
  F:18.9984032, Ne:20.1797, Na:22.98976928, Mg:24.3050, Al:26.9815386, Si:28.0855, P:30.973762,
  S:32.065, Cl:35.453, K:39.0983, Ar:39.948, Ca:40.078, Sc:44.955912, Ti:47.867, V:50.9415,
  Cr:51.9961, Mn:54.938045, Fe:55.845, Co:58.933195, Ni:58.6934, Cu:63.546, Zn:65.38, Ga:69.723,
  Ge:72.64, As:74.92160, Se:78.96, Br:79.904, Kr:83.798, Rb:85.4678, Sr:87.62, Y:88.90585,
  Zr:91.224, Nb:92.90638, Mo:95.96, Ru:101.07, Rh:102.90550, Pd:106.42, Ag:107.8682, Cd:112.411,
  In:114.818, Sn:118.710, Sb:121.760, Te:127.60, I:126.90447, Xe:131.293, Cs:132.9054519,
  Ba:137.327, La:138.90547, Ce:140.116, Pr:140.90765, Nd:144.242, Sm:150.36, Eu:151.964,
  Gd:157.25, Tb:158.92535, Dy:162.500, Ho:164.93032, Er:167.259, Tm:168.93421, Yb:173.054,
  Lu:174.9668, Hf:178.49, Ta:180.94788, W:183.84, Re:186.207, Os:190.23, Ir:192.217, Pt:195.084,
  Au:196.966569, Hg:200.59, Tl:204.3833, Pb:207.2, Bi:208.98040, Po:209, At:210, Rn:222
};
// 化学式パーサ（括弧対応）
function parseFormula(s){
  let i=0;
  function parseGroup(){
    let comp = {};
    while(i<s.length){
      if(s[i]==='('){
        i++; const inner=parseGroup();
        if(s[i]!==')') throw new Error(') が不足');
        i++;
        const num = readNum();
        multiplyInto(comp, inner, num||1);
      }else if(s[i]===')' || s[i]==='[' || s[i]===']'){
        break;
      }else{
        const el = readElem();
        if(!el) break;
        const num = readNum();
        comp[el]=(comp[el]||0)+(num||1);
      }
    }
    return comp;
  }
  function readElem(){
    if(!/[A-Z]/.test(s[i])) return null;
    let el=s[i++]; if(i<s.length && /[a-z]/.test(s[i])) el+=s[i++];
    return el;
  }
  function readNum(){
    let j=i; while(j<s.length && /[0-9]/.test(s[j])) j++;
    if(j===i) return 0;
    const n = parseInt(s.slice(i,j),10); i=j; return n;
  }
  function multiplyInto(dst, src, k){
    for(const e in src){ dst[e]=(dst[e]||0)+src[e]*k; }
  }
  const comp = parseGroup();
  if(i<s.length) throw new Error('未解釈の文字列があります');
  return comp;
}
function calcMW(){
  const f = (document.getElementById('formula').value||'').trim();
  if(!f){ show('outMW','化学式を入力してください。'); return; }
  try{
    const comp = parseFormula(f);
    let sum=0;
    const tbody=document.querySelector('#tblMW tbody'); tbody.innerHTML='';
    for(const el of Object.keys(comp)){
      if(!(el in AWT)) throw new Error(`未知の元素: ${el}`);
      const n = comp[el]; const aw = AWT[el]; const contrib = n*aw; sum += contrib;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${el}</td><td>${n}</td><td>${fmt(aw,6)}</td><td>${fmt(contrib,6)}</td>`;
      tbody.appendChild(tr);
    }
    document.getElementById('mwSum').textContent = fmt(sum,8)+' g/mol';
    document.getElementById('tblMW').style.display='table';
    show('outMW', `総分子量: ${fmt(sum,8)} g/mol`);
  }catch(e){
    show('outMW','エラー: '+e.message);
    document.getElementById('tblMW').style.display='none';
  }
}
</script>
</body>
</html>

