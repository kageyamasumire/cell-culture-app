<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>実験用 計算ツール集</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--line:#1f2937;--muted:#94a3b8;--hi:#93c5fd}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{font-size:1.35rem;margin:0 0 8px}
  h2{margin:10px 0}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin:12px 0}
  .muted{color:var(--muted);font-size:.92rem}
  .btn{padding:8px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .primary{background:#2563eb;color:#fff}
  .secondary{background:#374151;color:#fff}
  .out{white-space:pre-wrap;background:#0b1220;border:1px dashed #334155;border-radius:10px;padding:12px;margin-top:10px}
  .grid2{display:grid;gap:10px}
  @media(min-width:760px){.grid2{grid-template-columns:1fr 1fr}}
  .line{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:6px 0}
  .line strong{min-width:7em}
  .one-line{display:flex;align-items:center;gap:14px;white-space:nowrap;overflow-x:auto;padding:8px 10px;border:1px solid #1f2937;border-radius:10px;background:#0b1220}
  label{margin-right:4px}
  input[type="number"],input[type="text"]{width:110px;max-width:40vw;padding:6px 8px;border:1px solid #334155;border-radius:8px;background:#0b1220;color:#e5e7eb}
  select{padding:6px 8px;border:1px solid #334155;border-radius:8px;background:#0b1220;color:#e5e7eb}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #1f2937;padding:8px;text-align:right}
  th{background:#0f1a32}
  td:first-child,th:first-child{text-align:left}
  .eq{font-family:ui-monospace,Consolas,Menlo,monospace;color:var(--hi)}
</style>
</head>
<body>
<div class="wrap">
  <h1>実験用 計算ツール集</h1>

  <!-- 1. モル濃度（Selleck式：一行入力・自動推論） -->
  <div class="card">
    <h2>モル濃度計算（Selleck式 / 入力1行・自動推論）</h2>
    <p class="muted">式：<span class="eq">mg = mM × mL × g/mol</span>。<b>4項目のうち1つだけ空欄</b>にして「計算」を押すと、その値を求めます。</p>
    <div class="one-line">
      <label>質量:</label>
      <input id="mass" type="number" step="any" placeholder="数値">
      <select id="uMass"><option>mg</option><option>g</option><option>µg</option></select>

      <label>濃度:</label>
      <input id="conc" type="number" step="any" placeholder="数値">
      <select id="uConc"><option>mM</option><option>M</option><option>µM</option><option>nM</option></select>

      <label>体積:</label>
      <input id="vol" type="number" step="any" placeholder="数値">
      <select id="uVol"><option>mL</option><option>L</option><option>µL</option></select>

      <label>分子量:</label>
      <input id="mw" type="number" step="any" placeholder="g/mol" style="width:130px">
    </div>
    <div style="margin-top:10px">
      <button class="btn primary" onclick="calcSelleckAuto()">計算</button>
      <button class="btn secondary" onclick="resetSelleck()">リセット</button>
    </div>
    <div id="outS" class="out" style="display:none"></div>
  </div>

  <!-- 2. 希釈計算（C1V1=C2V2：一行入力） -->
  <div class="card">
    <h2>希釈計算（C1V1 = C2V2 / 入力1行）</h2>
    <p class="muted">未入力を<b>1つ</b>作って計算。M系同士 or %同士にそろえる。</p>
    <div class="one-line">
      <label>C1:</label><input id="c1" type="number"><select id="uC1"><option>M</option><option selected>mM</option><option>µM</option><option>nM</option><option>%</option></select>
      <label>V1:</label><input id="v1" type="number"><select id="uV1"><option>L</option><option selected>mL</option><option>µL</option></select>
      <span style="font-weight:700">=</span>
      <label>C2:</label><input id="c2" type="number"><select id="uC2"><option>M</option><option selected>mM</option><option>µM</option><option>nM</option><option>%</option></select>
      <label>V2:</label><input id="v2" type="number"><select id="uV2"><option>L</option><option selected>mL</option><option>µL</option></select>
    </div>
    <div style="margin-top:10px">
      <button class="btn primary" onclick="calcDil()">計算</button>
      <button class="btn secondary" onclick="resetDil()">リセット</button>
    </div>
    <div id="outDil" class="out" style="display:none"></div>
  </div>

  <!-- 3. 投与溶液組成 -->
  <div class="card">
    <h2>投与溶液組成計算機</h2>
    <p class="muted">動物数は+1匹で計算推奨。%は合計100%に。</p>
    <div class="line"><strong>投与量:</strong><input id="dose_mgkg" type="number"><span>mg/kg</span></div>
    <div class="line"><strong>平均体重:</strong><input id="avg_g" type="number"><span>g</span></div>
    <div class="line"><strong>投与体積:</strong><input id="vol_uL" type="number"><span>µL</span></div>
    <div class="line"><strong>動物数:</strong><input id="n_animals" type="number"><label><input id="add_one" type="checkbox" checked> +1匹で計算</label></div>
    <div class="grid2">
      <div class="line"><strong>DMSO:</strong><input id="p_dmsO" type="number" value="10"><span>%</span></div>
      <div class="line"><strong>PEG300:</strong><input id="p_peg" type="number" value="40"><span>%</span></div>
      <div class="line"><strong>Tween80:</strong><input id="p_tw" type="number" value="5"><span>%</span></div>
      <div class="line"><strong>ddH₂O:</strong><input id="p_h2o" type="number" value="45"><span>%</span></div>
    </div>
    <div style="margin-top:10px">
      <button class="btn primary" onclick="calcDose()">計算</button>
      <button class="btn secondary" onclick="resetDose()">リセット</button>
    </div>
    <div id="outDose" class="out" style="display:none"></div>
  </div>

  <!-- 4. 連続希釈 -->
  <div class="card">
    <h2>連続希釈計算</h2>
    <div class="line"><strong>初期濃度 C0:</strong><input id="c0" type="number"><select id="uC0"><option>M</option><option selected>mM</option><option>µM</option><option>nM</option></select></div>
    <div class="line"><strong>稀釈倍数 X:</strong><input id="xf" type="number" placeholder="例: 10"></div>
    <div><button class="btn primary" onclick="calcSerial()">計算</button></div>
    <div id="outSerial" class="out" style="display:none"></div>
    <table id="tblSerial" style="display:none"><thead><tr><th>段</th><th>濃度</th><th>単位</th><th>log10</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- 5. 分子量 -->
  <div class="card">
    <h2>分子量計算（化学式 → モル質量）</h2>
    <div class="line"><strong>化学式:</strong><input id="formula" type="text" placeholder="例: C10H16N2O2"></div>
    <div><button class="btn primary" onclick="calcMW()">計算</button></div>
    <div id="outMW" class="out" style="display:none"></div>
    <table id="tblMW" style="display:none"><thead><tr><th>元素</th><th>数</th><th>原子量</th><th>寄与</th></tr></thead><tbody></tbody><tfoot><tr><th colspan="3">合計</th><th id="mwSum"></th></tr></tfoot></table>
  </div>
</div>

<script>
/* ===== 共通ユーティリティ ===== */
const fmt=(x,d=6)=>!isFinite(x)?String(x):Number(x).toPrecision(d).replace(/(\.\d*?[1-9])0+$/,'$1').replace(/\.0+$/,'');
const concTo_mM=(v,u)=>u==='mM'?v:u==='M'?v*1000:(u==='µM'||u==='uM')?v/1000:u==='nM'?v/1e6:v;
const mM_toBest=mM=>mM>=1000?{v:mM/1000,u:'M'}:mM>=1?{v:mM,u:'mM'}:mM>=1e-3?{v:mM*1000,u:'µM'}:{v:mM*1e6,u:'nM'};
const volTo_mL=(v,u)=>u==='mL'?v:u==='L'?v*1000:(u==='µL'||u==='uL')?v/1000:v;
const mL_toBest=mL=>mL>=1000?{v:mL/1000,u:'L'}:mL>=1?{v:mL,u:'mL'}:{v:mL*1000,u:'µL'};
const massTo_mg=(v,u)=>u==='mg'?v:u==='g'?v*1000:(u==='µg'||u==='ug')?v/1000:v;
const mg_toBest=mg=>mg>=1000?{v:mg/1000,u:'g'}:mg>=1?{v:mg,u:'mg'}:{v:mg*1000,u:'µg'};
function show(id, text){const el=document.getElementById(id); el.style.display='block'; el.textContent=text;}
function hide(id){document.getElementById(id).style.display='none';}

/* ===== 1) モル濃度（Selleck式：自動推論） =====
   mg = mM × mL × MW
   未入力が1つだけ → それを解く
*/
function calcSelleckAuto(){
  const mass   = document.getElementById('mass').value.trim();
  const conc   = document.getElementById('conc').value.trim();
  const vol    = document.getElementById('vol').value.trim();
  const mw     = document.getElementById('mw').value.trim();
  const uMass  = document.getElementById('uMass').value;
  const uConc  = document.getElementById('uConc').value;
  const uVol   = document.getElementById('uVol').value;

  const out = document.getElementById('outS'); out.style.display='block';

  // 未入力カウント
  const empties = [mass==='', conc==='', vol==='', mw===''].filter(Boolean).length;
  if(empties!==1){ out.textContent='質量・濃度・体積・分子量のうち、ちょうど1つだけ空欄にしてください。'; return; }

  const mg  = mass!==''? massTo_mg(parseFloat(mass), uMass) : NaN;
  const mM  = conc!==''? concTo_mM(parseFloat(conc), uConc) : NaN;
  const mL  = vol!=='' ? volTo_mL(parseFloat(vol),  uVol)   : NaN;
  const MW  = mw!==''  ? parseFloat(mw) : NaN;

  // 入力値の妥当性チェック（入力されている値は >0 が望ましい）
  const pos = v => isFinite(v) && v>0;

  // どれを解く？
  if(isNaN(mg)){ // 質量 = mM*mL*MW
    if(!(pos(mM)&&pos(mL)&&pos(MW))){ out.textContent='入力値を確認してください（濃度・体積・分子量）。'; return; }
    const mgCalc = mM*mL*MW;
    const best = mg_toBest(mgCalc);
    out.textContent = `【結果】質量: ${fmt(mgCalc)} mg  ≈  ${fmt(best.v)} ${best.u}\n式: mg = ${fmt(mM)} mM × ${fmt(mL)} mL × ${fmt(MW)} g/mol`;
    return;
  }
  if(isNaN(mM)){ // 濃度 = mg/(mL*MW)
    if(!(pos(mg)&&pos(mL)&&pos(MW))){ out.textContent='入力値を確認してください（質量・体積・分子量）。'; return; }
    const mMcalc = mg/(mL*MW);
    const best = mM_toBest(mMcalc);
    out.textContent = `【結果】濃度: ${fmt(mMcalc)} mM  ≈  ${fmt(best.v)} ${best.u}\n式: mM = ${fmt(mg)} mg ÷ (${fmt(mL)} mL × ${fmt(MW)} g/mol)`;
    return;
  }
  if(isNaN(mL)){ // 体積 = mg/(mM*MW)
    if(!(pos(mg)&&pos(mM)&&pos(MW))){ out.textContent='入力値を確認してください（質量・濃度・分子量）。'; return; }
    const mLcalc = mg/(mM*MW);
    const best = mL_toBest(mLcalc);
    out.textContent = `【結果】体積: ${fmt(mLcalc)} mL  ≈  ${fmt(best.v)} ${best.u}\n式: mL = ${fmt(mg)} mg ÷ (${fmt(mM)} mM × ${fmt(MW)} g/mol)`;
    return;
  }
  if(isNaN(MW)){ // 分子量 = mg/(mM*mL)
    if(!(pos(mg)&&pos(mM)&&pos(mL))){ out.textContent='入力値を確認してください（質量・濃度・体積）。'; return; }
    const MWcalc = mg/(mM*mL);
    out.textContent = `【結果】分子量: ${fmt(MWcalc)} g/mol\n式: MW = ${fmt(mg)} mg ÷ (${fmt(mM)} mM × ${fmt(mL)} mL)`;
    return;
  }
}

function resetSelleck(){
  ['mass','conc','vol','mw'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('uMass').value='mg';
  document.getElementById('uConc').value='mM';
  document.getElementById('uVol').value='mL';
  hide('outS');
}

/* ===== 2) 希釈 C1V1=C2V2（一行入力） ===== */
function calcDil(){
  const c1=parseFloat(document.getElementById('c1').value), uC1=document.getElementById('uC1').value;
  const v1=parseFloat(document.getElementById('v1').value), uV1=document.getElementById('uV1').value;
  const c2=parseFloat(document.getElementById('c2').value), uC2=document.getElementById('uC2').value;
  const v2=parseFloat(document.getElementById('v2').value), uV2=document.getElementById('uV2').value;

  const out=document.getElementById('outDil'); out.style.display='block';
  const isPct=u=>u==='%';
  if ((isPct(uC1)&&!isPct(uC2)) || (!isPct(uC1)&&isPct(uC2))){
    out.textContent='濃度の単位は % 同士 か M系同士 に揃えてください。'; return;
  }

  let C1=isFinite(c1)? (isPct(uC1)? c1 : concTo_mM(c1,uC1)*1e-3) : NaN; // → M or %
  let C2=isFinite(c2)? (isPct(uC2)? c2 : concTo_mM(c2,uC2)*1e-3) : NaN; // mM→M
  let V1=isFinite(v1)? volTo_mL(v1,uV1)/1000 : NaN; // → L
  let V2=isFinite(v2)? volTo_mL(v2,uV2)/1000 : NaN; // → L

  const unknowns=[isNaN(C1),isNaN(V1),isNaN(C2),isNaN(V2)].filter(Boolean).length;
  if(unknowns!==1){ out.textContent='C1/V1/C2/V2 のうち、ちょうど1つを空欄にしてください。'; return; }

  if(isNaN(V1) && isFinite(C1) && isFinite(C2) && isFinite(V2)) V1=(C2*V2)/C1;
  else if(isNaN(V2) && isFinite(C1) && isFinite(C2) && isFinite(V1)) V2=(C1*V1)/C2;
  else if(isNaN(C1) && isFinite(V1) && isFinite(C2) && isFinite(V2)) C1=(C2*V2)/V1;
  else if(isNaN(C2) && isFinite(V2) && isFinite(C1) && isFinite(V1)) C2=(C1*V1)/V2;

  const v1Best=mL_toBest(V1*1000), v2Best=mL_toBest(V2*1000);
  const c1Disp=isPct(uC1)? `${fmt(C1)} %` : (()=>{const b=mM_toBest(C1*1e3); return `${fmt(b.v)} ${b.u}`;})();
  const c2Disp=isPct(uC2)? `${fmt(C2)} %` : (()=>{const b=mM_toBest(C2*1e3); return `${fmt(b.v)} ${b.u}`;})();

  out.textContent =
`C1×V1 = C2×V2

C1: ${c1Disp}
V1: ${fmt(v1Best.v)} ${v1Best.u}
C2: ${c2Disp}
V2: ${fmt(v2Best.v)} ${v2Best.u}

溶媒量（V2−V1）: ${fmt(v2Best.v - (V1*1000))} ${v2Best.u}`;
}
function resetDil(){
  ['c1','v1','c2','v2'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('uC1').value='mM'; document.getElementById('uC2').value='mM';
  document.getElementById('uV1').value='mL'; document.getElementById('uV2').value='mL';
  hide('outDil');
}

/* ===== 3) 投与溶液 ===== */
function calcDose(){
  const dose=parseFloat(document.getElementById('dose_mgkg').value); // mg/kg
  const avg_g=parseFloat(document.getElementById('avg_g').value);    // g
  const vol_uL=parseFloat(document.getElementById('vol_uL').value);  // µL/animal
  let n=parseInt(document.getElementById('n_animals').value||'0',10);
  const addOne=document.getElementById('add_one').checked;
  if(!(dose>0 && avg_g>0 && vol_uL>0 && n>0)){ show('outDose','入力を確認してください。'); return; }
  const nEff=addOne?n+1:n;
  const wt_kg=avg_g/1000;
  const dosePerAnimal_mg=dose*wt_kg;            // mg/animal
  const volPerAnimal_mL=vol_uL/1000;            // mL/animal
  const targetConc_mg_mL=dosePerAnimal_mg/volPerAnimal_mL; // mg/mL
  const totalVol_mL=volPerAnimal_mL*nEff;
  const totalAPI_mg=targetConc_mg_mL*totalVol_mL;

  // 溶媒%→mL
  const pD=parseFloat(document.getElementById('p_dmsO').value||'0');
  const pP=parseFloat(document.getElementById('p_peg').value||'0');
  const pT=parseFloat(document.getElementById('p_tw').value||'0');
  const pW=parseFloat(document.getElementById('p_h2o').value||'0');
  const sumP=pD+pP+pT+pW;
  if(Math.abs(sumP-100)>1e-6){ show('outDose',`溶媒の%合計が ${fmt(sumP)}% です。100% にしてください。`); return; }
  const vD=totalVol_mL*pD/100, vP=totalVol_mL*pP/100, vT=totalVol_mL*pT/100, vW=totalVol_mL*pW/100;

  const text=
`【結果】
・目標濃度: ${fmt(targetConc_mg_mL)} mg/mL
・総体積: ${fmt(totalVol_mL)} mL （${n}匹${addOne?'＋1匹分':''}）
・必要API量: ${fmt(totalAPI_mg)} mg

【溶媒配分（%→mL）】
DMSO: ${fmt(vD)} mL
PEG300: ${fmt(vP)} mL
Tween80: ${fmt(vT)} mL
ddH₂O: ${fmt(vW)} mL

【作業メモ】APIを DMSO(+一部PEG) → Tween80 → ddH₂O の順で溶解・仕上げ。SOP/安全情報に従ってください。`;
  show('outDose', text);
}
function resetDose(){
  ['dose_mgkg','avg_g','vol_uL','n_animals'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('p_dmsO').value=10; document.getElementById('p_peg').value=40;
  document.getElementById('p_tw').value=5; document.getElementById('p_h2o').value=45;
  document.getElementById('add_one').checked=true; hide('outDose');
}

/* ===== 4) 連続希釈 ===== */
function calcSerial(){
  const c0=parseFloat(document.getElementById('c0').value);
  const u0=document.getElementById('uC0').value;
  const X=parseFloat(document.getElementById('xf').value);
  if(!(c0>0 && X>1)){ show('outSerial','C0 (>0) と 稀釈倍数X (>1) を入力してください。'); return; }

  const C0_M=concTo_mM(c0,u0)*1e-3; // → M
  show('outSerial', `初期: ${fmt(c0)} ${u0} ＝ ${fmt(C0_M)} M`);

  const tbody=document.querySelector('#tblSerial tbody'); tbody.innerHTML='';
  for(let i=1;i<=8;i++){
    const Ci_M=C0_M/Math.pow(X,i);
    const best=mM_toBest(Ci_M*1e3); // → mM系表示
    const log10=Math.log10(Ci_M);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>C${i}</td><td>${fmt(best.v)}</td><td>${best.u}</td><td>${isFinite(log10)?fmt(log10,5):'−∞'}</td>`;
    tbody.appendChild(tr);
  }
  document.getElementById('tblSerial').style.display='table';
}

/* ===== 5) 分子量（化学式） ===== */
const AWT={H:1.00794, He:4.002602, Li:6.941, Be:9.012182, B:10.811, C:12.0107, N:14.0067, O:15.9994,
F:18.9984032, Ne:20.1797, Na:22.98976928, Mg:24.3050, Al:26.9815386, Si:28.0855, P:30.973762, S:32.065,
Cl:35.453, K:39.0983, Ar:39.948, Ca:40.078, Sc:44.955912, Ti:47.867, V:50.9415, Cr:51.9961, Mn:54.938045,
Fe:55.845, Co:58.933195, Ni:58.6934, Cu:63.546, Zn:65.38, Ga:69.723, Ge:72.64, As:74.92160, Se:78.96,
Br:79.904, Kr:83.798, Rb:85.4678, Sr:87.62, Y:88.90585, Zr:91.224, Nb:92.90638, Mo:95.96, Ru:101.07,
Rh:102.90550, Pd:106.42, Ag:107.8682, Cd:112.411, In:114.818, Sn:118.710, Sb:121.760, Te:127.60,
I:126.90447, Xe:131.293, Cs:132.9054519, Ba:137.327, La:138.90547, Ce:140.116, Pr:140.90765, Nd:144.242,
Sm:150.36, Eu:151.964, Gd:157.25, Tb:158.92535, Dy:162.500, Ho:164.93032, Er:167.259, Tm:168.93421,
Yb:173.054, Lu:174.9668, Hf:178.49, Ta:180.94788, W:183.84, Re:186.207, Os:190.23, Ir:192.217, Pt:195.084,
Au:196.966569, Hg:200.59, Tl:204.3833, Pb:207.2, Bi:208.98040};

function parseFormula(s){
  s=s.trim(); let i=0;
  function parseGroup(){
    let comp={};
    while(i<s.length){
      if(s[i]==='('){ i++; const inner=parseGroup(); if(s[i]!==')') throw new Error(') が不足'); i++; const num=readNum(); multiplyInto(comp,inner,num||1); }
      else if(s[i]===')'){ break; }
      else{
        const el=readElem(); if(!el) break;
        const num=readNum(); comp[el]=(comp[el]||0)+(num||1);
      }
    } return comp;
  }
  function readElem(){ if(!/[A-Z]/.test(s[i])) return null; let el=s[i++]; if(i<s.length && /[a-z]/.test(s[i])) el+=s[i++]; return el; }
  function readNum(){ let j=i; while(j<s.length && /[0-9]/.test(s[j])) j++; if(j===i) return 0; const n=parseInt(s.slice(i,j),10); i=j; return n; }
  function multiplyInto(dst,src,k){ for(const e in src) dst[e]=(dst[e]||0)+src[e]*k; }
  const comp=parseGroup(); if(i<s.length) throw new Error('未解釈の文字列があります'); return comp;
}
function calcMW(){
  const f=(document.getElementById('formula').value||'').trim();
  if(!f){ show('outMW','化学式を入力してください。'); return; }
  try{
    const comp=parseFormula(f); let sum=0;
    const tbody=document.querySelector('#tblMW tbody'); tbody.innerHTML='';
    for(const el of Object.keys(comp)){
      if(!(el in AWT)) throw new Error(`未知の元素: ${el}`);
      const n=comp[el], aw=AWT[el], contrib=n*aw; sum+=contrib;
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${el}</td><td>${n}</td><td>${fmt(aw,6)}</td><td>${fmt(contrib,6)}</td>`;
      tbody.appendChild(tr);
    }
    document.getElementById('mwSum').textContent=fmt(sum,8)+' g/mol';
    document.getElementById('tblMW').style.display='table';
    show('outMW','総分子量: '+fmt(sum,8)+' g/mol');
  }catch(e){ show('outMW','エラー: '+e.message); document.getElementById('tblMW').style.display='none'; }
}
</script>
</body>
</html>
